<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>HMI CLOUD ‚Äì WinTK Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#2b2b2b; font-family:Arial }
#hmi { width:900px; height:520px; background:#e6e6e6; margin:30px auto; border:3px solid #333 }
#titlebar { height:38px; background:#004aad; color:white; line-height:38px; padding-left:10px; font-weight:bold }
#menu { background:#d0d0d0; padding:5px }
#menu button { margin-right:5px }
.screen { display:none; padding:15px }
.screen.active { display:block }
.value-box { width:180px; padding:12px; background:black; color:lime; font-size:30px; text-align:center }
#statusDot { width:10px; height:10px; border-radius:50%; background:red; display:inline-block }
table { border-collapse:collapse; width:100% }
td,th { border:1px solid #333; padding:4px 8px; text-align:center }
</style>
</head>

<body>
<div id="hmi">
<div id="titlebar">HMI CLOUD MONITOR (WinTK Style)</div>

<div id="menu">
<button onclick="showScreen('s1')">M√†n 1</button>
<button onclick="showScreen('s2')">M√†n 2</button>
<button onclick="showScreen('s3')">M√†n 3</button>
<button onclick="showScreen('s4')">üìà ƒê·ªì th·ªã</button>
<button onclick="showScreen('s5')">üïí L·ªãch s·ª≠</button>
</div>

<div id="s1" class="screen active">
<h3>M√ÄN H√åNH CH√çNH</h3>
<div class="value-box" id="hmiValue">---</div>
<p><span id="statusDot"></span> <span id="statusText">Disconnected</span></p>
</div>

<div id="s2" class="screen">
<h3>TH√îNG TIN</h3>
<p>HMI: WinTK</p>
<p>Gateway: NodeJS</p>
<p>Cloud: Render</p>
</div>

<div id="s3" class="screen">
<h3>MIRROR</h3>
<div class="value-box" id="mirrorValue">---</div>
</div>

<div id="s4" class="screen">
<h3>ƒê·ªí TH·ªä LW5</h3>
<div style="height:260px; border:1px solid #333;">
  <canvas id="chart"></canvas>
</div>
</div>

<div id="s5" class="screen">
<h3>L·ªäCH S·ª¨ LW5</h3>
<div style="height:260px; overflow-y:auto; border:1px solid #333;">
<table>
<thead>
<tr><th>Time</th><th>Value</th></tr>
</thead>
<tbody id="log"></tbody>
</table>
</div>
</div>
</div>

<script>
function showScreen(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}

/* ===== Chart ===== */
const chart = new Chart(document.getElementById("chart"), {
 type:"line",
 data:{
   labels:[],
   datasets:[{
     label:"LW5",
     data:[],
     borderColor:"lime",
     tension:0.2
   }]
 },
 options:{
   responsive:true,
   maintainAspectRatio:false,
   animation:false
 }
});

let lastHistoryLength = 0;

/* ===== Fetch ===== */
async function fetchData(){
 try{
  const r = await fetch("/api/status");
  const d = await r.json();
  updateUI(d);
 }catch{}
}

function updateUI(d){
 const c = d.hmi_connected;

 document.getElementById("statusText").innerText = c?"Connected":"Disconnected";
 document.getElementById("statusDot").style.background = c?"lime":"red";

 document.getElementById("hmiValue").innerText = c ? d.hmi_value : "---";
 document.getElementById("mirrorValue").innerText = c ? d.hmi_value : "---";

 if (!Array.isArray(d.history)) return;

 // üî• CH·ªà c·∫≠p nh·∫≠t khi c√≥ d·ªØ li·ªáu M·ªöI
 if (d.history.length > lastHistoryLength) {
   const last = d.history[d.history.length - 1];
   lastHistoryLength = d.history.length;

   chart.data.labels.push(last.t);
   chart.data.datasets[0].data.push(last.v);

   if (chart.data.labels.length > 50) {
     chart.data.labels.shift();
     chart.data.datasets[0].data.shift();
   }

   chart.update();

   document.getElementById("log").insertAdjacentHTML(
     "afterbegin",
     `<tr><td>${last.t}</td><td>${last.v}</td></tr>`
   );
 }
}

setInterval(fetchData, 1000);
</script>
</body>
</html>
